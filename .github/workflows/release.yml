name: Create NHK World TV Release for Kodi

on:
    push:
        # Sequence of patterns matched against refs/tags
        tags:
            - "v*.*.*" # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
    validate:
        name: Validate addon
        runs-on: ubuntu-24.04
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Set up Python 3.12
              uses: actions/setup-python@v6
              with:
                  python-version: "3.12"

            - name: Install kodi-addon-checker
              run: |
                  python -m pip install --upgrade pip
                  pip install kodi-addon-checker

            - name: Run addon validation for Omega
              run: |
                  kodi-addon-checker --branch=omega plugin.video.nhkworldtv

    build:
        name: Build and release plugin
        runs-on: ubuntu-24.04
        needs: validate
        steps:
            - name: Set up Python 3.12
              uses: actions/setup-python@v6
              with:
                  python-version: "3.12"

            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Install dependencies with pipenv
              run: |
                  sudo apt install pipenv
                  pipenv install --dev

            - name: Build plugin ZIP archive
              id: build_plugin
              run: |
                  cd plugin.video.nhkworldtv
                  pipenv run submit-addon -z .

            - name: Create Release
              id: create_release
              uses: softprops/action-gh-release@v2
              with:
                  files: plugin.video.nhkworldtv/plugin.video.nhkworldtv-*.zip
                  body: |
                      ## Installation
                      Download the ZIP file and install via Kodi's "Install from zip file" option.

                      ## Changelog
                      See addon.xml for detailed changes.

                      ## Compatibility
                      - Kodi Omega (v21) and later
