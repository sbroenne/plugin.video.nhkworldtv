name: Push addon to plugin repo branches

on:
    workflow_dispatch:
        inputs:
            branch:
                description: "Kodi branch to push to"
                required: true
                default: "omega"
                type: choice
                options:
                    - omega
                    - piers

jobs:
    validate:
        name: Validate addon with kodi-addon-checker
        runs-on: ubuntu-24.04
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Set up Python 3.12
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install kodi-addon-checker
              run: |
                  python -m pip install --upgrade pip
                  pip install kodi-addon-checker

            - name: Run addon validation
              run: |
                  kodi-addon-checker --branch=${{ github.event.inputs.branch }} plugin.video.nhkworldtv

    push:
        name: Push to repo branch
        runs-on: ubuntu-24.04
        needs: validate
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Set up Python 3.12
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install kodi-addon-submitter
              run: |
                  pip install git+https://github.com/xbmc/kodi-addon-submitter.git

            - name: Configure git
              run: |
                  git config --global user.name "${{ github.actor }}"
                  git config --global user.email "${{ secrets.EMAIL }}"

            - name: Push to Kodi repo branch
              env:
                  GH_USERNAME: ${{ github.actor }}
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
                  EMAIL: ${{ secrets.EMAIL }}
              run: |
                  submit-addon -r repo-plugins -b ${{ github.event.inputs.branch }} --push-branch plugin.video.nhkworldtv
